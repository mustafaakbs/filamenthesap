<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Teklif Pro V2.2</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --secondary: #64748b; --bg: #f8fafc; --surface: #ffffff; --border: #e2e8f0; --danger: #ef4444; --success: #10b981; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #1e293b; margin: 0; padding: 20px; }

        /* Grid Yapƒ±sƒ± */
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        
        /* Kartlar */
        .card { background: var(--surface); padding: 15px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; font-weight: 700; color: #334155; }
        
        /* Formlar */
        label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--secondary); margin-top: 8px; margin-bottom: 2px;}
        input, select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; box-sizing: border-box; }
        input:focus, select:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* Sekmeler (Tab) */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #f1f5f9; padding: 5px; border-radius: 8px; }
        .tab-btn { flex: 1; border: none; background: transparent; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 600; color: #64748b; transition: 0.2s; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Butonlar */
        .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: #334155; }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-sm { padding: 3px 8px; font-size: 0.75rem; width: auto; cursor: pointer; border-radius: 4px; margin-left: 5px; border: 1px solid transparent;}
        .btn-edit-mode { background: #fff7ed; border: 1px solid #fdba74; color: #c2410c; } /* D√ºzenleme modu uyarƒ±sƒ± */

        /* Ge√ßmi≈ü Teklifler Listesi */
        .quote-item { background: #f8fafc; border: 1px solid var(--border); padding: 10px; margin-bottom: 5px; border-radius: 6px; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .quote-item:hover { border-color: var(--primary); }
        .quote-item.active-editing { border: 2px solid var(--success); background: #f0fdf4; } /* D√ºzenlenen √∂ƒüe stili */
        .quote-info strong { display: block; color: #334155; }
        .quote-info span { color: #94a3b8; font-size: 0.75rem; }

        /* Tablo ve Toplamlar */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 8px; background: #f1f5f9; color: #475569; font-size: 0.8rem; }
        td { padding: 8px; border-bottom: 1px solid var(--border); }
        .total-section { display: flex; justify-content: flex-end; gap: 20px; margin-top: 20px; text-align: right; }
        .grand-total { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        
        .fil-item { font-size: 0.8rem; padding: 5px; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; align-items: center; }

        /* --- YAZDIRMA (TEKLƒ∞F KAƒûIDI) --- */
        #printableArea { display: none; }
        @media print {
            body { background: white; padding: 0; margin: 0; }
            .no-print { display: none !important; }
            .container { display: block; max-width: 100%; }
            #printableArea { display: block; padding: 40px; }
            
            .invoice-header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px; }
            .company-name { font-size: 1.8rem; font-weight: bold; color: var(--primary); margin: 0; }
            .meta-data { text-align: right; }

            .print-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            .print-table th { background: #eee !important; border: 1px solid #000; padding: 8px; font-weight: bold; -webkit-print-color-adjust: exact; }
            .print-table td { border: 1px solid #ccc; padding: 8px; }
            
            .print-footer { display: flex; justify-content: space-between; margin-top: 40px; }
            .signature-box { border-top: 1px solid #000; width: 200px; text-align: center; padding-top: 10px; margin-top: 40px; }
        }
    </style>
</head>
<body>

<div class="container no-print">
    <div class="sidebar">
        <div class="card" style="border-left: 4px solid var(--primary);">
            <div id="cloudStatus" style="font-size:0.85rem; font-weight:bold; color:#64748b; margin-bottom:10px;">‚òÅÔ∏è Baƒülanƒ±yor...</div>
            <button class="btn btn-primary" onclick="saveSettings()">üíæ Genel Ayarlarƒ± Kaydet</button>
        </div>

        <div class="card">
            <div class="card-header">‚öôÔ∏è Maliyet Ayarlarƒ±</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div><label>Elektrik (TL/kW)</label><input type="number" id="cfg_elec"></div>
                <div><label>G√º√ß (Watt)</label><input type="number" id="cfg_power"></div>
            </div>
            <label>Makine Yƒ±pranma (TL/Saat)</label><input type="number" id="cfg_depreciation" placeholder="√ñrn: 5">
            <label>K√¢r Oranƒ± (%)</label><input type="number" id="cfg_margin">
            <label>KDV (%)</label><input type="number" id="cfg_tax">
            <label>Firma Adƒ±</label><input type="text" id="cfg_company">
        </div>

        <div class="card">
            <div class="card-header">üìÇ Kayƒ±tlƒ± Teklifler</div>
            <div id="savedQuotesList" style="max-height: 250px; overflow-y: auto;">
                <div style="text-align:center; color:#999; font-size:0.8rem;">Y√ºkleniyor...</div>
            </div>
        </div>
    </div>

    <div class="main">
        <div class="card" id="projectCard">
            <div class="card-header">
                üìù Proje Bilgileri
                <span id="editModeBadge" style="display:none; font-size:0.7rem; background:#fff7ed; color:#c2410c; padding:3px 8px; border-radius:10px; border:1px solid #fdba74;">D√úZENLEME MODU</span>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                <div><label>M√º≈üteri Adƒ±</label><input type="text" id="custName"></div>
                <div><label>Proje Ba≈ülƒ±ƒüƒ±</label><input type="text" id="projName"></div>
            </div>

            <div style="display:flex; gap:10px;">
                <button id="btnSaveQuote" class="btn btn-success" onclick="saveQuoteToCloud()">‚òÅÔ∏è TEKLƒ∞Fƒ∞ KAYDET</button>
                <button class="btn btn-outline" onclick="resetForm(true)">‚ú® Yeni / Temizle</button>
            </div>
        </div>

        <div class="card">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('print')">üñ®Ô∏è 3D Baskƒ± Ekle</button>
                <button class="tab-btn" onclick="switchTab('manual')">‚ö° Ekstra / Elektronik</button>
            </div>

            <div id="tab_print" class="tab-content active">
                <div style="display:grid; grid-template-columns: 2fr 1.5fr 0.8fr 0.8fr 0.8fr auto; gap:8px; align-items:end;">
                    <div><label>Par√ßa Adƒ±</label><input type="text" id="pName" placeholder="G√∂vde"></div>
                    <div><label>Filament</label><select id="pMat"></select></div>
                    <div><label>Gr</label><input type="number" id="pWeight" placeholder="0"></div>
                    <div><label>Saat</label><input type="number" id="pTime" placeholder="0"></div>
                    <div><label>Adet</label><input type="number" id="pQty" value="1"></div>
                    <button class="btn btn-primary" style="width:auto;" onclick="addPrintItem()">EKLE</button>
                </div>
                
                <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                    <label style="margin-bottom:5px;">‚ûï Yeni Filament Ekle / Mevcutlarƒ± D√ºzenle</label>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input type="text" id="newFilName" placeholder="Ad (√ñrn: ABS)" style="width:50%;">
                        <input type="number" id="newFilPrice" placeholder="Fiyat (TL)" style="width:30%;">
                        <button class="btn btn-outline" style="width:20%; font-size:0.8rem;" onclick="addFilament()">Ekle</button>
                    </div>
                    
                    <div id="filamentManagerList" style="max-height:100px; overflow-y:auto; border:1px solid #f1f5f9; padding:5px; border-radius:6px; background:#f8fafc;">
                        </div>
                </div>
            </div>

            <div id="tab_manual" class="tab-content">
                <div style="display:grid; grid-template-columns: 3fr 1fr 1fr auto; gap:10px; align-items:end;">
                    <div><label>ƒ∞≈ülem / Par√ßa Adƒ±</label><input type="text" id="mName" placeholder="√ñrn: Arduino, Boyama, Montaj"></div>
                    <div><label>Adet</label><input type="number" id="mQty" value="1"></div>
                    <div><label>Birim Fiyat (TL)</label><input type="number" id="mPrice" placeholder="Satƒ±≈ü Fiyatƒ±"></div>
                    <button class="btn btn-primary" style="width:auto; background:#10b981;" onclick="addManualItem()">Lƒ∞STEYE EKLE</button>
                </div>
                <div style="margin-top:5px; font-size:0.8rem; color:#666;">* Manuel eklemelerde k√¢r oranƒ± uygulanmaz, direkt satƒ±≈ü fiyatƒ± girin.</div>
            </div>
        </div>

        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>T√ºr</th>
                        <th>A√ßƒ±klama</th>
                        <th>Detaylar</th>
                        <th>Adet</th>
                        <th style="text-align:right;">Tutar</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="cartBody"></tbody>
            </table>

            <div class="total-section">
                <div>
                    <div>Ara Toplam: <span id="dspSub">0.00</span> ‚Ç∫</div>
                    <div>KDV (%<span id="dspTaxRate">20</span>): <span id="dspTaxAmt">0.00</span> ‚Ç∫</div>
                    <div class="grand-total" id="dspGrand">0.00 ‚Ç∫</div>
                </div>
            </div>

            <button class="btn btn-primary" style="margin-top:20px; background:#334155;" onclick="window.print()">üñ®Ô∏è YAZDIR / PDF AL</button>
        </div>
    </div>
</div>

<div id="printableArea">
    <div class="invoice-header">
        <div>
            <h1 class="company-name" id="prtCompany">Fƒ∞RMA ADI</h1>
            <p>3D Baskƒ±, Prototipleme ve Elektronik Hizmetleri</p>
        </div>
        <div class="meta-data">
            <h2 style="margin:0;">Fƒ∞YAT TEKLƒ∞Fƒ∞</h2>
            <p id="prtDate">01.01.2024</p>
        </div>
    </div>

    <div style="margin-bottom:20px;">
        <strong>Sayƒ±n:</strong> <span id="prtCust"></span><br>
        <strong>Proje:</strong> <span id="prtProj"></span>
    </div>

    <table class="print-table">
        <thead>
            <tr>
                <th>A√ßƒ±klama</th>
                <th>Malzeme / ƒ∞≈ülem</th>
                <th>Birim Detay</th>
                <th>Miktar</th>
                <th style="text-align:right;">Toplam Fiyat</th>
            </tr>
        </thead>
        <tbody id="prtTable"></tbody>
    </table>

    <div style="text-align:right;">
        <p>Ara Toplam: <span id="prtSub">0.00</span> ‚Ç∫</p>
        <p>KDV (%<span id="prtTaxRate"></span>): <span id="prtTaxAmt">0.00</span> ‚Ç∫</p>
        <h3 style="font-size:1.4rem;">GENEL TOPLAM: <span id="prtGrand">0.00</span> ‚Ç∫</h3>
    </div>

    <div class="print-footer">
        <div class="signature-box">
            Teklifi Hazƒ±rlayan<br><br><br>................................
        </div>
        <div class="signature-box">
            Onaylayan / M√º≈üteri<br><br><br>................................
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- FIREBASE AYARLARI ---
    const firebaseConfig = {
      apiKey: "AIzaSyCaIPCr-1yDII529VK_83uvnjUHhquisDA",
      authDomain: "filament-51e0a.firebaseapp.com",
      databaseURL: "https://filament-51e0a-default-rtdb.firebaseio.com",
      projectId: "filament-51e0a",
      storageBucket: "filament-51e0a.firebasestorage.app",
      messagingSenderId: "644889839032",
      appId: "1:644889839032:web:ecb23c5d9191ae0418fb4d",
      measurementId: "G-PP30K2BB77"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    // Referanslar
    const settingsRef = ref(db, 'settings');
    const quotesRef = ref(db, 'quotes');

    // Durum Deƒüi≈ükenleri
    let settings = {
        company: "My 3D Workshop",
        elecPrice: 3.5,
        power: 300,
        depreciation: 5, 
        margin: 50,
        tax: 20,
        filaments: [{ id: 1, name: "PLA", price: 500 }]
    };
    
    let cart = []; 
    let currentEditingId = null; // ≈ûu an d√ºzenlenen teklif ID'si

    // --- BA≈ûLANGI√á ---
    onValue(settingsRef, (snapshot) => {
        const val = snapshot.val();
        if(val) settings = val;
        renderUI();
        document.getElementById('cloudStatus').innerText = "‚úÖ Bulut Aktif";
        document.getElementById('cloudStatus').style.color = "#10b981";
    });

    onValue(quotesRef, (snapshot) => {
        const listDiv = document.getElementById('savedQuotesList');
        listDiv.innerHTML = "";
        const quotes = snapshot.val();
        
        if(quotes) {
            Object.entries(quotes).reverse().forEach(([key, q]) => { 
                const date = new Date(q.timestamp).toLocaleDateString();
                // D√ºzenlenen √∂ƒüeyi vurgula
                const activeClass = (key === currentEditingId) ? 'active-editing' : '';
                
                const div = document.createElement('div');
                div.className = `quote-item ${activeClass}`;
                div.innerHTML = `
                    <div class="quote-info" onclick="loadQuote('${key}')" style="cursor:pointer; flex:1;">
                        <strong>${q.customer || 'ƒ∞simsiz'}</strong>
                        <span>${date} - ${q.total} ‚Ç∫</span>
                    </div>
                    <div>
                        <button class="btn-sm btn-outline" onclick="loadQuote('${key}')">D√ºzenle</button>
                        <button class="btn-sm btn-danger" onclick="deleteQuote('${key}')">Sil</button>
                    </div>
                `;
                listDiv.appendChild(div);
            });
        } else {
            listDiv.innerHTML = "<div style='text-align:center; padding:10px; font-size:0.8rem;'>Hen√ºz kayƒ±tlƒ± teklif yok.</div>";
        }
    });

    // --- FONKSƒ∞YONLAR ---
    
    window.switchTab = (tabName) => {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab_' + tabName).classList.add('active');
        event.target.classList.add('active');
    };

    window.saveSettings = () => {
        settings.company = document.getElementById('cfg_company').value;
        settings.elecPrice = parseFloat(document.getElementById('cfg_elec').value);
        settings.power = parseFloat(document.getElementById('cfg_power').value);
        settings.depreciation = parseFloat(document.getElementById('cfg_depreciation').value) || 0;
        settings.margin = parseFloat(document.getElementById('cfg_margin').value);
        settings.tax = parseFloat(document.getElementById('cfg_tax').value);
        set(settingsRef, settings).then(() => alert("Ayarlar Kaydedildi!"));
    };

    // YENƒ∞: Teklif Kaydetme Mantƒ±ƒüƒ± (G√ºncelleme Desteƒüi)
    window.saveQuoteToCloud = () => {
        if(cart.length === 0) { alert("Liste bo≈ü! Kaydedilecek bir ≈üey yok."); return; }
        
        const grandTotal = document.getElementById('dspGrand').innerText;
        const quoteData = {
            customer: document.getElementById('custName').value,
            project: document.getElementById('projName').value,
            cart: cart,
            total: grandTotal,
            timestamp: Date.now() // Her g√ºncellemede tarih yenilenir
        };
        
        if(currentEditingId) {
            // G√ºncelleme Modu
            update(ref(db, 'quotes/' + currentEditingId), quoteData)
                .then(() => alert("Teklif G√ºncellendi!"))
                .catch(e => alert("Hata: " + e));
        } else {
            // Yeni Kayƒ±t Modu
            push(quotesRef, quoteData)
                .then((snap) => {
                    alert("Yeni Teklif Olu≈üturuldu!");
                    currentEditingId = snap.key; // Kayƒ±ttan sonra d√ºzenleme moduna ge√ß
                    updateEditModeUI();
                });
        }
    };

    // YENƒ∞: Teklif Y√ºkleme
    window.loadQuote = (key) => {
        const specificRef = ref(db, 'quotes/' + key);
        onValue(specificRef, (snap) => {
            const data = snap.val();
            if(data) {
                currentEditingId = key; // ID'yi hafƒ±zaya al
                
                document.getElementById('custName').value = data.customer;
                document.getElementById('projName').value = data.project;
                cart = data.cart || [];
                
                renderCart();
                updateEditModeUI(); // Aray√ºz√º g√ºncelle
                
                // Listeyi yenile ki vurgu (highlight) √ßalƒ±≈üsƒ±n
                // (Otomatik listener zaten yapacak ama hƒ±zlƒ± tepki i√ßin manuel √ßaƒüƒ±rabiliriz, ≈üimdilik gerek yok)
            }
        }, { onlyOnce: true });
    };

    // YENƒ∞: Teklif Silme
    window.deleteQuote = (key) => {
        if(confirm("Bu teklifi kalƒ±cƒ± olarak silmek istiyor musunuz?")) {
            remove(ref(db, 'quotes/' + key)).then(() => {
                // Eƒüer sildiƒüimiz teklif ≈üu an ekranda a√ßƒ±ksa, ekranƒ± temizle
                if(currentEditingId === key) {
                    resetForm(false); 
                }
            });
        }
    };

    // YENƒ∞: Form Sƒ±fƒ±rlama
    window.resetForm = (confirmReset) => {
        if(confirmReset && cart.length > 0 && !confirm("Kaydedilmemi≈ü deƒüi≈üiklikler kaybolacak. Yeni teklife ge√ßilsin mi?")) return;
        
        currentEditingId = null;
        cart = [];
        document.getElementById('custName').value = "";
        document.getElementById('projName').value = "";
        renderCart();
        updateEditModeUI();
    };

    // Aray√ºz D√ºzenleme Modu Kontrol√º
    function updateEditModeUI() {
        const btn = document.getElementById('btnSaveQuote');
        const badge = document.getElementById('editModeBadge');
        const card = document.getElementById('projectCard');

        if(currentEditingId) {
            btn.innerText = "üíæ G√úNCELLE";
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
            badge.style.display = 'inline-block';
            card.style.border = "2px solid #fdba74"; // Turuncu √ßer√ßeve
        } else {
            btn.innerText = "‚òÅÔ∏è TEKLƒ∞Fƒ∞ KAYDET";
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-success');
            badge.style.display = 'none';
            card.style.border = "1px solid #e2e8f0"; // Normal √ßer√ßeve
        }
    }

    // Filament Y√∂netimi
    window.addFilament = () => {
        const name = document.getElementById('newFilName').value;
        const price = parseFloat(document.getElementById('newFilPrice').value);
        if(name && price) {
            if(!settings.filaments) settings.filaments = [];
            settings.filaments.push({ id: Date.now(), name, price });
            renderUI(); 
            saveSettings(); 
            document.getElementById('newFilName').value = '';
            document.getElementById('newFilPrice').value = '';
        }
    };

    window.deleteFilament = (id) => {
        if(confirm("Silmek istiyor musunuz?")) {
            settings.filaments = settings.filaments.filter(f => f.id !== id);
            renderUI(); saveSettings();
        }
    };

    window.addPrintItem = () => {
        const name = document.getElementById('pName').value || "Par√ßa";
        const weight = parseFloat(document.getElementById('pWeight').value);
        const time = parseFloat(document.getElementById('pTime').value);
        const qty = parseFloat(document.getElementById('pQty').value) || 1;
        const matSel = document.getElementById('pMat');
        
        if(!weight || !time || !matSel.value) return;
        
        cart.push({
            type: 'print', name, weight, time, qty,
            matPrice: parseFloat(matSel.value),
            matName: matSel.options[matSel.selectedIndex].text
        });
        renderCart();
    };

    window.addManualItem = () => {
        const name = document.getElementById('mName').value;
        const price = parseFloat(document.getElementById('mPrice').value);
        const qty = parseFloat(document.getElementById('mQty').value) || 1;
        if(!name || !price) return;
        cart.push({ type: 'manual', name: name, qty: qty, price: price });
        renderCart();
    };

    window.removePart = (idx) => { cart.splice(idx, 1); renderCart(); };

    // --- RENDER ---
    function renderUI() {
        document.getElementById('cfg_company').value = settings.company;
        document.getElementById('cfg_elec').value = settings.elecPrice;
        document.getElementById('cfg_power').value = settings.power;
        document.getElementById('cfg_depreciation').value = settings.depreciation || 0;
        document.getElementById('cfg_margin').value = settings.margin;
        document.getElementById('cfg_tax').value = settings.tax;

        const sel = document.getElementById('pMat');
        const managerList = document.getElementById('filamentManagerList');
        sel.innerHTML = ""; managerList.innerHTML = "";

        if(settings.filaments) {
            settings.filaments.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.price; opt.text = f.name; sel.appendChild(opt);

                const item = document.createElement('div');
                item.className = 'fil-item';
                item.innerHTML = `<span><b>${f.name}</b> (${f.price} TL)</span><span onclick="deleteFilament(${f.id})" style="color:red; cursor:pointer;">[Sƒ∞L]</span>`;
                managerList.appendChild(item);
            });
        }
    }

    function renderCart() {
        const tbody = document.getElementById('cartBody');
        const prtBody = document.getElementById('prtTable');
        tbody.innerHTML = ""; prtBody.innerHTML = "";
        
        let subTotal = 0;

        cart.forEach((p, i) => {
            let rowTotal = 0;
            let detailTxt = "";
            let desc = "";

            if(p.type === 'print') {
                const matCost = (p.matPrice / 1000) * p.weight;
                const elecCost = (settings.power / 1000) * p.time * settings.elecPrice;
                const depCost = (settings.depreciation || 0) * p.time;
                const unitCost = (matCost + elecCost + depCost) * (1 + (settings.margin / 100));
                rowTotal = unitCost * p.qty;
                desc = `<span style='color:#2563eb;'>3D Baskƒ±</span>`;
                detailTxt = `${p.matName} (${p.weight}gr / ${p.time}sa)`;
            } else {
                rowTotal = p.price * p.qty;
                desc = `<span style='color:#10b981;'>Ekstra</span>`;
                detailTxt = "-";
            }
            
            subTotal += rowTotal;

            tbody.innerHTML += `<tr><td>${desc}</td><td>${p.name}</td><td style="font-size:0.8rem; color:#666;">${detailTxt}</td><td>${p.qty}</td><td style="text-align:right;">${rowTotal.toFixed(2)} ‚Ç∫</td><td style="text-align:center;"><button class="btn-sm btn-danger" onclick="removePart(${i})">X</button></td></tr>`;
            prtBody.innerHTML += `<tr><td>${p.name}</td><td>${p.type === 'print' ? p.matName : 'Ekstra'}</td><td>${p.type === 'print' ? (p.weight+'gr / '+p.time+'sa') : '-'}</td><td>${p.qty}</td><td style="text-align:right;">${rowTotal.toFixed(2)} ‚Ç∫</td></tr>`;
        });

        const taxAmt = subTotal * (settings.tax / 100);
        const grand = subTotal + taxAmt;

        document.getElementById('dspSub').innerText = subTotal.toFixed(2);
        document.getElementById('dspTaxRate').innerText = settings.tax;
        document.getElementById('dspTaxAmt').innerText = taxAmt.toFixed(2);
        document.getElementById('dspGrand').innerText = grand.toFixed(2) + " ‚Ç∫";

        document.getElementById('prtCompany').innerText = settings.company;
        document.getElementById('prtDate').innerText = new Date().toLocaleDateString();
        document.getElementById('prtCust').innerText = document.getElementById('custName').value;
        document.getElementById('prtProj').innerText = document.getElementById('projName').value;
        document.getElementById('prtSub').innerText = subTotal.toFixed(2);
        document.getElementById('prtTaxRate').innerText = settings.tax;
        document.getElementById('prtTaxAmt').innerText = taxAmt.toFixed(2);
        document.getElementById('prtGrand').innerText = grand.toFixed(2);
    }
</script>

</body>
</html>
