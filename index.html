<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Print Cloud Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; --border: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .container { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        h2 { font-size: 1.1rem; border-bottom: 2px solid var(--bg); padding-bottom: 10px; margin-top: 0; }
        label { display: block; font-size: 0.85rem; font-weight: 600; color: #64748b; margin-top: 10px; }
        input, select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; }
        
        /* Butonlar */
        button { cursor: pointer; border: none; border-radius: 6px; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; padding: 10px 20px; width: 100%; }
        .btn-danger { background: #fee2e2; color: #ef4444; padding: 4px 8px; font-size: 0.8rem; }
        .btn-outline { background: white; border: 1px solid var(--primary); color: var(--primary); width: 100%; padding: 5px; }
        
        /* Cloud Butonlarƒ± */
        .cloud-status { padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; font-weight: bold; background: #e2e8f0; color: #64748b; }
        .cloud-active { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .btn-save-cloud { background: #0f172a; color: white; width: 100%; padding: 12px; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .btn-save-cloud:hover { background: #334155; }

        /* Tablo */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th { text-align: left; padding: 10px; background: #f1f5f9; }
        td { padding: 10px; border-bottom: 1px solid var(--border); }
        
        .filament-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 8px; margin-bottom: 5px; border-radius: 6px; font-size: 0.9rem; }

        /* Print */
        #printableArea { display: none; }
        @media print {
            body { background: white; padding: 0; }
            .no-print { display: none !important; }
            .container { display: block; max-width: 100%; }
            #printableArea { display: block; padding: 40px; }
            .invoice-table { width: 100%; border-collapse: collapse; }
            .invoice-table th, .invoice-table td { border: 1px solid #ddd; padding: 8px; }
            .invoice-header { display: flex; justify-content: space-between; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px;}
        }
    </style>
</head>
<body>

<div class="container no-print">
    <div class="sidebar">
        <div class="card">
            <h2>‚òÅÔ∏è Bulut Baƒülantƒ±sƒ±</h2>
            <div id="statusBox" class="cloud-status">Baƒülanƒ±yor...</div>
            <p style="font-size:0.8rem; color:#666;">Ayarlarƒ± deƒüi≈ütirdiƒüinizde a≈üaƒüƒ±daki butona basƒ±n. Google sunucularƒ±na kaydolur.</p>
            <button class="btn-save-cloud" onclick="saveToCloud()">
                üíæ Ayarlarƒ± Buluta Kaydet
            </button>
        </div>

        <div class="card">
            <h2>‚öôÔ∏è Ayarlar</h2>
            <label>Firma Adƒ±</label><input type="text" id="cfg_company">
            <label>Elektrik (TL/kWh)</label><input type="number" id="cfg_elec">
            <label>Yazƒ±cƒ± G√ºc√º (Watt)</label><input type="number" id="cfg_power">
            <label>K√¢r Oranƒ± (%)</label><input type="number" id="cfg_margin">
            <label>KDV Oranƒ± (%)</label><input type="number" id="cfg_tax">
        </div>

        <div class="card">
            <h2>üßµ Filamentler</h2>
            <div id="filamentList"></div>
            <div style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                <input type="text" id="newFilName" placeholder="Adƒ± (√ñrn: TPU)" style="margin-bottom: 5px;">
                <input type="number" id="newFilPrice" placeholder="Fiyat (TL)">
                <button class="btn-outline" onclick="addFilament()" style="margin-top: 5px;">+ Ekle</button>
            </div>
        </div>
    </div>

    <div class="main">
        <div class="card">
            <h2>üìù Proje</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><label>M√º≈üteri</label><input type="text" id="custName"></div>
                <div><label>Proje</label><input type="text" id="projName"></div>
            </div>
        </div>

        <div class="card">
            <h2>‚ûï Par√ßa Ekle</h2>
            <div style="display: grid; grid-template-columns: 2fr 2fr 1fr 1fr auto; gap: 10px; align-items: end;">
                <div><label>Par√ßa</label><input type="text" id="pName" placeholder="Ad"></div>
                <div><label>Malzeme</label><select id="pMat"></select></div>
                <div><label>Gr</label><input type="number" id="pWeight" placeholder="0"></div>
                <div><label>Saat</label><input type="number" id="pTime" placeholder="0"></div>
                <button class="btn-primary" onclick="addPart()">EKLE</button>
            </div>
        </div>

        <div class="card">
            <h2>Sepet</h2>
            <table>
                <thead><tr><th>Par√ßa</th><th>Malzeme</th><th>Tutar</th><th></th></tr></thead>
                <tbody id="cartBody"></tbody>
            </table>
            <div style="text-align: right; margin-top: 20px; font-size: 1.2rem; font-weight: bold;">
                Toplam: <span id="dspGrand" style="color:var(--primary)">0.00 ‚Ç∫</span>
            </div>
            <button class="btn-primary" style="margin-top: 20px; background: #334155;" onclick="window.print()">üñ®Ô∏è Teklifi Yazdƒ±r</button>
        </div>
    </div>
</div>

<div id="printableArea">
    <div class="invoice-header">
        <div><h1 id="prtCompany" style="margin:0; color:#2563eb;">Fƒ∞RMA</h1><p>3D Hizmetleri</p></div>
        <div style="text-align: right;"><h2>TEKLƒ∞F</h2><p id="prtDate"></p></div>
    </div>
    <p><strong>Sayƒ±n:</strong> <span id="prtCust"></span></p>
    <table class="invoice-table">
        <thead><tr style="background:#eee;"><th>Par√ßa</th><th>Malzeme</th><th>Gr</th><th>Saat</th><th style="text-align:right;">Fiyat</th></tr></thead>
        <tbody id="prtTable"></tbody>
    </table>
    <div style="text-align: right; margin-top: 20px;"><h3>GENEL TOPLAM: <span id="prtGrand">0.00</span> ‚Ç∫</h3></div>
</div>

<script type="module">
    // Firebase K√ºt√ºphanelerini CDN'den √ßekiyoruz
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- Sƒ∞Zƒ∞N FIREBASE Bƒ∞LGƒ∞LERƒ∞Nƒ∞Z ---
    const firebaseConfig = {
      apiKey: "AIzaSyCaIPCr-1yDII529VK_83uvnjUHhquisDA",
      authDomain: "filament-51e0a.firebaseapp.com",
      databaseURL: "https://filament-51e0a-default-rtdb.firebaseio.com",
      projectId: "filament-51e0a",
      storageBucket: "filament-51e0a.firebasestorage.app",
      messagingSenderId: "644889839032",
      appId: "1:644889839032:web:ecb23c5d9191ae0418fb4d",
      measurementId: "G-PP30K2BB77"
    };

    // Firebase'i Ba≈ülat
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const settingsRef = ref(db, 'settings');

    // --- Veri Deƒüi≈ükenleri ---
    let data = {
        company: "Firma Adƒ± Girin",
        elecPrice: 3.5,
        power: 300,
        margin: 50,
        tax: 20,
        filaments: [{ id: 1, name: "PLA Demo", price: 500 }]
    };
    let cart = [];

    // --- SAYFA A√áILINCA BULUTTAN VERƒ∞ √áEK ---
    onValue(settingsRef, (snapshot) => {
        const cloudData = snapshot.val();
        const statusBox = document.getElementById('statusBox');
        
        if (cloudData) {
            data = cloudData; 
            statusBox.innerText = "‚úÖ Buluta Baƒülƒ± - Veriler G√ºncel";
            statusBox.className = "cloud-status cloud-active";
            initUI(); 
        } else {
            statusBox.innerText = "‚ö†Ô∏è Bulut Bo≈ü - ƒ∞lk Kaydƒ± Yapƒ±n";
            initUI();
        }
    });

    // --- BULUTA KAYDET ---
    window.saveToCloud = function() {
        // Formdan g√ºncel verileri topla
        data.company = document.getElementById('cfg_company').value;
        data.elecPrice = parseFloat(document.getElementById('cfg_elec').value);
        data.power = parseFloat(document.getElementById('cfg_power').value);
        data.margin = parseFloat(document.getElementById('cfg_margin').value);
        data.tax = parseFloat(document.getElementById('cfg_tax').value);
        
        // Firebase'e g√∂nder
        set(settingsRef, data)
            .then(() => {
                alert("Ba≈üarƒ±lƒ±! Ayarlar kaydedildi.");
            })
            .catch((error) => {
                alert("Hata olu≈ütu: " + error);
            });
    };

    // --- UI G√úNCELLEMELERƒ∞ ---
    function initUI() {
        document.getElementById('cfg_company').value = data.company || "";
        document.getElementById('cfg_elec').value = data.elecPrice;
        document.getElementById('cfg_power').value = data.power;
        document.getElementById('cfg_margin').value = data.margin;
        document.getElementById('cfg_tax').value = data.tax;
        renderFilaments();
        updateSelect();
    }

    // Filament ƒ∞≈ülemleri
    window.addFilament = function() {
        const name = document.getElementById('newFilName').value;
        const price = parseFloat(document.getElementById('newFilPrice').value);
        if(name && price) {
            if(!data.filaments) data.filaments = [];
            data.filaments.push({ id: Date.now(), name, price });
            renderFilaments();
            updateSelect();
        }
    }

    window.removeFilament = function(id) {
        if(confirm('Sil?')) {
            data.filaments = data.filaments.filter(f => f.id !== id);
            renderFilaments();
            updateSelect();
        }
    }

    function renderFilaments() {
        const list = document.getElementById('filamentList');
        list.innerHTML = '';
        if(data.filaments) {
            data.filaments.forEach(f => {
                list.innerHTML += `<div class="filament-item"><span>${f.name} (${f.price} TL)</span><button class="btn-danger" onclick="removeFilament(${f.id})">Sil</button></div>`;
            });
        }
    }

    function updateSelect() {
        const sel = document.getElementById('pMat');
        sel.innerHTML = '';
        if(data.filaments) {
            data.filaments.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.price;
                opt.text = f.name;
                sel.appendChild(opt);
            });
        }
    }

    // Par√ßa ƒ∞≈ülemleri
    window.addPart = function() {
        const name = document.getElementById('pName').value || 'Par√ßa';
        const weight = parseFloat(document.getElementById('pWeight').value);
        const time = parseFloat(document.getElementById('pTime').value);
        const matSel = document.getElementById('pMat');
        
        if(!weight || !time || !matSel.value) return;

        cart.push({
            name, weight, time,
            matPrice: parseFloat(matSel.value),
            matName: matSel.options[matSel.selectedIndex].text
        });
        renderCart();
    }
    
    window.removePart = function(idx) { cart.splice(idx, 1); renderCart(); }

    function renderCart() {
        const body = document.getElementById('cartBody');
        const prtBody = document.getElementById('prtTable');
        body.innerHTML = ''; prtBody.innerHTML = '';
        
        let subTotal = 0;
        cart.forEach((p, i) => {
            const matCost = (p.matPrice / 1000) * p.weight;
            const elecCost = (data.power / 1000) * p.time * data.elecPrice;
            const cost = (matCost + elecCost) * (1 + (data.margin / 100));
            subTotal += cost;

            body.innerHTML += `<tr><td>${p.name}</td><td>${p.matName}</td><td>${cost.toFixed(2)} TL</td><td><button class="btn-danger" onclick="removePart(${i})">X</button></td></tr>`;
            prtBody.innerHTML += `<tr><td>${p.name}</td><td>${p.matName}</td><td>${p.weight}</td><td>${p.time}</td><td style="text-align:right;">${cost.toFixed(2)} TL</td></tr>`;
        });

        const grand = subTotal + (subTotal * (data.tax/100));
        document.getElementById('dspGrand').innerText = grand.toFixed(2) + " ‚Ç∫";
        document.getElementById('prtGrand').innerText = grand.toFixed(2);
        
        // Print Details
        document.getElementById('prtCompany').innerText = data.company;
        document.getElementById('prtDate').innerText = new Date().toLocaleDateString();
        document.getElementById('prtCust').innerText = document.getElementById('custName').value;
    }
</script>

</body>
</html>
